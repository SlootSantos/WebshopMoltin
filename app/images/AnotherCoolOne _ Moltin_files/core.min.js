/* -------------------- Check Browser --------------------- */

function generate_slug(input_form, output_form, space_character, disallow_dashes) { space_character = space_character || '-'; $(input_form).slugify({ slug: output_form, type: space_character }); }

function browser() {
    function i(e) {
        return e in document.documentElement.style
    }
    var e = !! window.opera && !! window.opera.version,
        t = i("MozBoxSizing"),
        n = Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor") > 0,
        r = !n && i("WebkitTransform");
    return e ? !1 : n || r ? !0 : !1
}

function retina() {
    retinaMode = window.devicePixelRatio > 1;
    return retinaMode
}

function hexToRgb(e) {
    var t = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);
    return t ? {
        r: parseInt(t[1], 16),
        g: parseInt(t[2], 16),
        b: parseInt(t[3], 16)
    } : null
}

function rgbToRgba(e, t) {
    if (jQuery.browser.version <= 8) {
        e = hexToRgb(e);
        rgba = "rgba(" + e.r + "," + e.g + "," + e.b + "," + t + ")"
    } else {
        e = e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
        rgba = "rgba(" + e[1] + "," + e[2] + "," + e[3] + "," + t + ")"
    }
    return rgba
}

function widthFunctions(e) {
    $(".timeline") && $(".timeslot").each(function () {
        var e = $(this).find(".task").outerHeight();
        $(this).css("height", e)
    });
    var t = $("#sidebar-left").outerHeight(),
        n = $("#content").height(),
        r = $("#content").outerHeight(),
        b = $('body > header.navbar').outerHeight(),
        i = $(window).height(),
        s = $(window).width();
    if (s > 767) {
        $("#content").css("min-height", i - b);
        $("#white-area").css("height", r)
    } else $("#white-area").css("height", "auto");
    s < 768 ? $(".chat-full") && $(".chat-full").each(function () {
        $(this).addClass("alt")
    }) : $(".chat-full") && $(".chat-full").each(function () {
        $(this).removeClass("alt")
    })
}
jQuery(document).ready(function (e) {
    if ( window.location.hash ) { if ( window.location.hash.substring(0,5) == '#tab-' ) { e("a[href='"+window.location.hash+"']").click(); } }

    e(document).on('hidden.bs.modal', function(ev) { e(ev.target).removeData('bs.modal'); });

    jQuery.browser.version.substring(0, 2) == "8." && e(".hideInIE8").remove();
    e('a[href="#"][data-top!=true]').click(function (e) {
        e.preventDefault()
    });
    e(".noty").click(function (t) {
        t.preventDefault();
        var n = e.parseJSON(e(this).attr("data-noty-options"));
        noty(n)
    });
    e("#myTab a:first").tab("show");
    e("#myTab a").click(function (t) {
        t.preventDefault();
        e(this).tab("show");
    });
    e('[rel="tooltip"],[data-rel="tooltip"]').tooltip({
        placement: "bottom",
        delay: {
            show: 400,
            hide: 200
        }
    });
    e('[rel="popover"],[data-rel="popover"],[data-toggle="popover"]').popover();
    e("#toggle-fullscreen").button().click(function () {
        var t = e(this),
            n = document.documentElement;
        if (!t.hasClass("active")) {
            e("#thumbnails").addClass("modal-fullscreen");
            n.webkitRequestFullScreen ? n.webkitRequestFullScreen(window.Element.ALLOW_KEYBOARD_INPUT) : n.mozRequestFullScreen && n.mozRequestFullScreen()
        } else {
            e("#thumbnails").removeClass("modal-fullscreen");
            (document.webkitCancelFullScreen || document.mozCancelFullScreen || e.noop).apply(document)
        }
    });
    e(".btn-close").click(function (t) {
        t.preventDefault();
        e(this).parent().parent().parent().fadeOut()
    });
    e(".btn-minimize").click(function (t) {
        t.preventDefault();
        var n = e(this).parent().parent().next(".box-content");
        n.is(":visible") ? e("i", e(this)).removeClass("icon-chevron-up").addClass("icon-chevron-down") : e("i", e(this)).removeClass("icon-chevron-down").addClass("icon-chevron-up");
        n.slideToggle("slow", function () {
            widthFunctions()
        })
    });
    e(".btn-setting").click(function (t) {
        t.preventDefault();
        e("#myModal").modal("show")
    });
    if ( e('#nestable').size() > 0 ) {
        e('#nestable-menu').on('click', function(e) {
            var target = e(e.target), action = target.data('action');
            if (action === 'expand-all') { e('.dd').nestable('expandAll'); }
            if (action === 'collapse-all') { e('.dd').nestable('collapseAll'); }
        });        
        e('#nestable').nestable({maxDepth:10}).on('change', function() {
            e.post('/category/order', {order: e(this).nestable('serialize')});
        });
    }

    if ( e('#tableSettings').size() > 0 ) {
        var header = e('.box-content .table thead tr th'), cont = e('#tableSettings'), form = e('#tableSettings form');
        var cur = [];// var cur = e.cookie('form_'+cont.data('type')).split(',');
        function buildTable(fields) {
            form.find('input[type=checkbox]').each(function() { var no = e(this).val(); e('.box-content .table thead tr').each(function(){ e(this).find('th:eq('+no+')').hide(); }); e('.box-content .table tbody tr').each(function(){ e(this).find('td:eq('+no+')').hide(); }); });
            for ( var i in fields ) { var no = e('.box-content .table thead tr th[data-type="'+fields[i]+'"]').index(); e('.box-content .table thead tr').each(function(){ e(this).find('th:eq('+no+')').show(); }); e('.box-content .table tbody tr').each(function(){ e(this).find('td:eq('+no+')').show(); }); }
        }
        header.each(function() {
            if ( e(this).text().length <= 1 ) { return; }
            form.find('fieldset').append('<div class="form-group"><input type="checkbox" name="'+e(this).data('type')+'" value="'+e(this).index()+'" '+( e.inArray(e(this).data('type'), cur) ? 'checked="checked" ' : '' )+'/> <label class="control-label" for="'+e(this).data('type')+'">'+e(this).html()+'</label></div>');
        });
        form.find('input[type=checkbox]').on('change', function() {
            fields = []; form.find('input:checked').each(function() { fields.push(e(this).attr('name')); }); /*e.cookie('form_'+cont.data('type'), fields);*/ cur = fields;
            buildTable(fields);
        }).first().trigger('change');
    }

    e('.multilingual').each(function() {
        var t = e(this);
        $(t).addClass('input-full');
        $(t).parent('.controls').addClass('input-group');
        var flag = '/assets/img/flags/'+current_language+'.png';
        $.ajax({
          url: flag,
          success: function(data){
            $(t).parent('.controls').html('<div class="input-group-addon"><img style="height: 20px;" src="'+flag+'" /></div>'+$(t).parent('.controls').html());
          },
          error: function(data){
            $(t).parent('.controls').html('<div class="input-group-addon" title="default language"><i class="icon-globe"></i></div>'+$(t).parent('.controls').html());
          },
        })
    });

    e('.datepicker').each(function() {
        var t = e(this);
        $(t).addClass('input-full');
        $(t).parent('.controls').addClass('input-group');
        $(t).parent('.controls').html('<div class="input-group-addon"><i class="icon-calendar"></i></div>'+$(t).parent('.controls').html());
    });

    e('.money').each(function() {
        var t = e(this);
        $(t).addClass('input-full');
        $(t).parent('.controls').addClass('input-group');
        $(t).parent('.controls').html('<div class="input-group-addon">'+currency_symbol+'</div>'+$(t).parent('.controls').html());
    });

    if (typeof current_language == 'undefined') {
        current_language = "default";
    }
    // current language
    var flag = '/assets/img/flags/'+current_language+'.png';
    $.ajax({
      url: flag,
      success: function(data){
        $('#language').html('<img style="width: 20px;" src="'+flag+'" />');
      },
      error: function(data){
        $('#language').html('<i class="icon-globe">');
      },
    })

    /* e('.slug').each(function() {
        var t = e(this);
        if ( ! t.hasClass('disabled') ) { e(e(this).data('parent')).slugify({slug: '#'+e(this).attr('id'), type: '-'}); }
    }); */

    if ( e('#dropbox').size() > 0 ) {
        var d = e('#dropbox');
        moltin.bind_upload('/'+d.data('type')+'/upload/'+d.data('id'));
    }

    $('#dropbox .delete').on('click', function(e) {
        e.preventDefault(); var t = $(this);
        $.get($(this).attr('href'), function(data) {
            if ( data == '1' ) { noty({type:'success',layout:'topRight',text:"Image deleted successfully"}); t.parents('.preview').remove(); if( !$.trim( $('#dropbox').html() ).length ) { $('#dropbox').html("<span class='message'>Click or Drop your images here</span>"); } }
            else { noty({type:'error',layout:'topRight',text:"Error deleting image"}); }
        });
    });

    e('textarea').removeAttr('contenteditable');

    e('.form-horizontal button[type=submit]').on('click', function() {
        var f = e(this).parents('.form-horizontal'), c = {};
        var ht = f.hasClass('tab-content');
        if ( ht ) { e('.tab-menu .badge').remove(); }
        f.find('input, select, textarea').each(function() {
            var p = e(this).parents('.form-group'); p.removeClass('has-error');
            if (e(this).val() == '' && e(this).is(':required')) {
                p.addClass('has-error');
                if ( ht ) { var t = p.parent().parent().attr('id'); if( typeof c[t] == 'undefined' ) { c[t] = 0; } c[t] += 1; }
            }
        });
        if ( ht ) { for ( var k in c ) { e('.tab-menu a[href="#'+k+'"]').append('<span class="badge">'+c[k]+'</span>'); } }
    });

    if ( e('input[name=sku]').size() <= 0 ) {
        if(typeof moltin != 'undefined') {
            moltin.bind_barcode(function(b) {
                e.ajax({dataType: "json", url: '/ajax/barcodefind/'+b,
                    error: function() { noty({type:'error',layout:'topRight',text:b+" was not found."}); },
                    success: function(d) { window.location='/product/edit/'+d.id; }
                });
            });
        }
    }

    $('a.btn-danger:not(.nostop), a.icon-remove:not(.nostop)').click(function (event) { 
        event.preventDefault(); 
        $('#confirmDanger .btn-success').attr('href', '');
        $('#confirmDanger .btn-success').attr('href', $(this).attr('href'));
        $('#confirmDanger').modal('show');
    });


    renderSelect();
    // renderWYSIWYG();
    renderDatePicker();
    renderCountries();
});

function renderCountries() {

    var url = window.location.protocol+'//'+window.location.host+'/';

    $('select[data-fieldtype="country"]').each(function( index ) {
        // add initially selected flag
        var code = $('select[data-fieldtype="country"]').val().toLowerCase();
        var active = $(this).parent().parent().find('.bootstrap-select .btn');
        $(active).css('paddingLeft', '40px');
        $(this).parent().parent().find('.bootstrap-select .btn .flag').remove();
        $(active).html('<img class="flag" style="margin-right: 10px; height: 20px; display: inline-block; position: absolute; left: 10px; float: left;" src="'+url+'assets/img/flags/'+code+'.png"/>'+$(active).html());
        // add flags to each select picker option
        $(this).find('option').each(function(){
            var code = $(this).val().toLowerCase();
            var index = $(this).index();
            var current = $(this).parent().parent().find('.bootstrap-select ul li[rel="'+index+'"] a');
            $(current).html('<img style="margin-right: 10px; height: 20px; display: inline-block; float: left;" src="'+url+'assets/img/flags/'+code+'.png"/>'+$(current).html());
        });
    });    

    // update selected flag on change
    $('select[data-fieldtype="country"]').on('change', function(){
        var code = $(this).val().toLowerCase();
        var active = $(this).parent().parent().find('.bootstrap-select .btn');
        $(active).css('paddingLeft', '40px');
        $(this).parent().parent().find('.bootstrap-select .btn .flag').remove();
        $(active).html('<img class="flag" style="margin-right: 10px; height: 20px; display: inline-block; position: absolute; left: 10px; float: left;" src="'+url+'assets/img/flags/'+code+'.png"/>'+$(active).html());        
    });

}

function renderSelect() {
    $( "select" ).each(function( index ) {
        // if more than 5 options - add a search filter
        if ($(this).children().length > 5) {
            $(this).selectpicker({
                liveSearch: true,
                size: 5
            });
        } else {
            $(this).selectpicker({
                size: 5
            }); 
        }
    });    
}

function renderWYSIWYG(){
    $('.wysiwyg').summernote({
        height: 300,
        disableDragAndDrop: true, // disable drag and drop event
        toolbar: [
          ['style', ['style']],
          ['font', ['bold', 'italic', 'underline', 'clear', 'strikethrough', 'fontsize']],
          ['color', ['color']],
          ['para', ['ul', 'ol', 'paragraph']],
          ['table', ['table']],
          ['insert', ['link', 'video']],
          ['extra', ['codeview']],
          ['help', ['help']]
        ]
    });

    $(".note-editable").on('focus blur', function() {
        $(this).parents(".controls").find("textarea.wysiwyg").val($(this).html());
    });

    $('.box-content form').on('submit', function(e) {
        e.preventDefault();
        $(".note-editable").each(function() {
            $(this).parents(".controls").find("textarea.wysiwyg").val($(this).html());
        });
        $(this).unbind('submit').submit();
    });
}

function renderDatePicker(){
    $('input.datepicker').datepicker();
}

jQuery(document).ready(function (e) {
    e(".discussions").find(".delete").click(function () {
        e(this).parent().fadeTo("slow", 0, function () {
            e(this).slideUp("slow", function () {
                e(this).remove()
            })
        })
    })
});
jQuery(document).ready(function (e) {
    e(".messagesList").width() && jQuery.browser.version.substring(0, 2) == "8." && e("ul.messagesList li:nth-child(2n+1)").addClass("odd")
});
jQuery(document).ready(function (e) {
    e("ul.main-menu li a").each(function () {
        e(e(this))[0].href == String(window.location) && e(this).parent().addClass("active")
    });

    // get first part of url
    var first = $(location).attr('pathname');
    first.indexOf(1);
    first.toLowerCase();
    first = first.split("/")[1];

    e("ul.main-menu li ul li a").each(function () {
        if ( (e(e(this))[0].href == String(window.location)) || (e(e(this))[0].href == window.location.protocol+'//'+window.location.hostname+'/'+first) ) {
            e(this).parent().addClass("active");
            e(this).parent().parent().show();
            e(this).parent().parent().siblings('a').addClass("active");
        }
    });
    e(".dropmenu").click(function (t) {
        t.preventDefault();
        if ($(this).parent().find("ul").is(":visible") ) {
            $(this).parent().find("ul").hide();
        } else {
            $( ".dropmenu" ).each(function() {
                $(this).parent().find("ul").hide();
            });
            e(this).parent().find("ul").slideToggle();
        }
    })
});
jQuery(document).ready(function (e) {
    var t = !0;
    e("#main-menu-toggle").click(function () {
        if (e(this).hasClass("open")) {
            e(this).removeClass("open").addClass("close");
            var t = e("#content").attr("class"),
                n = parseInt(t.replace(/^\D+/g, "")),
                r = n + 2,
                i = "span" + r;
            e("#content").addClass("full");
            e(".navbar-brand").addClass("noBg");
            e("#sidebar-left").addClass("minimise-sidebar");
        } else {
            e(this).removeClass("close").addClass("open");
            var t = e("#content").attr("class"),
                n = parseInt(t.replace(/^\D+/g, "")),
                r = n - 2,
                i = "span" + r;
            e("#content").removeClass("full");
            e(".navbar-brand").removeClass("noBg");
            e("#sidebar-left").removeClass("minimise-sidebar");
        }
    })
});
jQuery(document).ready(function (e) {
    if (e(".todo-actions").length) {
        e(".todo-actions > a").click(function () {
            if (e(this).find("i").attr("class") == "icon-check-empty") {
                e(this).find("i").removeClass("icon-check-empty").addClass("icon-check");
                e(this).parent().parent().find("span").css({
                    opacity: .25
                });
                e(this).parent().parent().find(".desc").css("text-decoration", "line-through")
            } else {
                e(this).find("i").removeClass("icon-check").addClass("icon-check-empty");
                e(this).parent().parent().find("span").css({
                    opacity: 1
                });
                e(this).parent().parent().find(".desc").css("text-decoration", "none")
            }
            return !1
        });
        e(function () {
            e(".todo-list").sortable();
            e(".todo-list").disableSelection()
        })
    }
});
$(document).ready(function () {
    widthFunctions()
});
$(window).bind("resize", widthFunctions);
